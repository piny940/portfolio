## 目次
[1. はじめに](#1-はじめに)  
[2. 作ったアプリについて](#2-作ったアプリについて)  
[3. 開発の流れ](#3-開発の流れ)  
[4. プロジェクトを通して学んだこと](#4-プロジェクトを通して学んだこと)  

## 1. はじめに
discordのようにグループトークができるチャットアプリを開発したのでその記録を記します。

## 2. 作ったアプリについて
[2-1 アプリの概要](#2-1-アプリの概要)  
[2-2 アプリの3つの特徴](#2-2-アプリの3つの特徴)  
[2-3 アプリの画面](#2-3-アプリの画面)  

### 2-1 アプリの概要
このチャットアプリは部活動やサークルで使われることを想定して制作しました。部活ごとに「グループ」を作成し、グループごとに複数のトークルームを作ることができます。

![アプリ画面](https://i.gyazo.com/f52ca83a56757a43dabe11d5e46c0e42.png)

### 2-2 アプリの3つの特徴
[1. グループごとにトークルームを整理できる](#1-グループごとにトークルームを整理できる)  
[2. トークルームに簡単に招待ができる](#2-トークルームに簡単に招待ができる)  
[3. レスポンシブデザイン](#3-レスポンシブデザイン)  

#### 1. グループごとにトークルームを整理できる
このアプリは、LINEにおいて1つのサークルで「学園祭用のグループ」や「合宿用のグループ」「団体戦用のグループ」など複数のグループチャットを作成してトークルームがごちゃついてしまうという問題を解消するという目的で作成しました。  
このアプリでは、グループごとに複数のトークルームを作ることができ、トークルームをわかりやすく整理することができます。

1枚目: サッカー部のグループ、2枚目: 3年1組のグループ
![サッカー部のグループ](https://i.gyazo.com/f52ca83a56757a43dabe11d5e46c0e42.png)
![3年1組のグループ](https://i.gyazo.com/6beee4fb89d3f3baaae179ad2827ff41.png)

#### 2. トークルームに簡単に招待ができる
LINEなどではグループチャットにクラスのメンバーを招待するために全員を招待する手間が必要でした。  
このアプリでは、複数のメンバーをグループやトークルームに手軽に招待できるよう、1つの招待リンクを使って複数の友達を招待できるようにしました。

たくさんの友達を招待したい時は、招待リンクを渡すだけで招待ができます！

左: グループ設定画面、右: トークルーム招待画面  
<img src="https://i.gyazo.com/8e9729828a73045ef6b66066c35c0e51.png" alt="グループ招待" width="400" class="custom">
<img src="https://i.gyazo.com/f55885c6f073664d74dd8029c89c7931.png" alt="トークルーム招待" width="400" class="custom">

#### 3. レスポンシブデザイン
スマートフォンから見てもレイアウトが崩れないよう工夫しました。  
<img src="https://i.gyazo.com/24e21b68c9d9b3b9575e85daa6619150.png" alt="スマホ画面" width="400" class="custom">

### 2-3 アプリの画面
- トップページ
チャンネルを選択します。

<img src="https://i.gyazo.com/33e373b4aa20416f047191f597f73f34.png" alt="トップページ" width="500" class="custom">

- チャンネル画面  
選択したチャンネルについて見ることができます。

左側にはこれまでに歌った曲の一覧が表示されます。検索欄には**タイトル/歌手名**を入力して絞り込みをします。  

右側にはこれまでの歌枠の一覧が表示されます。動画を選択すると、その動画の中で歌われた曲の一覧を見ることができます。
![チャンネル画面](https://i.gyazo.com/3b91db481cfd4a50a79f925c44218683.png)
![動画を選択したチャンネル画面](https://i.gyazo.com/0158d7c73bc8171793315101a4327cef.png)

- メンテナンス画面  
左側から歌を1つ選択すると、その歌が歌われた時間・タイトル名・歌手名を編集できるようになっています。

編集フォームにはこれまでの修正履歴が表示されており、誤った情報が登録された場合は過去の状態に簡単に戻せるようになっています。
![メンテナンス画面](https://i.gyazo.com/ab542c917b79679ada00b4a4f225f7a1.png)

## 3. 開発の流れ
2023年3月〜5月で要件定義・開発を行いました。開発全体を通して設計・実装を全て1人で行いました。

|時期|内容|
|--|--|
|3月|要件定義・設計|
|4・5月|開発|

### 使用技術
**バックエンド**  
- Rails
- テスト: Rspec

**フロントエンド**  
- Next.js(React.js)
- Typescript
- テスト: jest


## 4. プロジェクトを通して学んだこと
### 4-1. 履歴情報の保持
開発初期の頃は、下図のように1つの歌を表す*song_items*テーブルと歌情報の変更履歴を表す*song_diffs*テーブルを一対多の関係で持ち、歌のタイトル名や歌手名を参照する際は**created_atが最新の*song_diff*が持つタイトル名や歌手名を参照する**という方法をとっていました。

<img src="https://i.gyazo.com/f78a5ea74818140e52a7077dba175126.png" alt="開発初期のER図" width="300" class="custom">

しかし、この方法では以下のような問題が発生しました。  
- タイトル等の情報を取得するために毎回「*created_at*が最新である*song_diff*をselectする」というクエリを発行する必要があり、クエリが複雑になる
- 「歌の一覧」を取得するためには、各歌に対して「*created_at*が最新である*song_diff*をselectする」というクエリを発行する必要があり、N+1問題が生じる

そこで、この問題を解決するために、下図のように*song_items*テーブルに*latest_diff_id*を追加するという修正を行いました。*song_items*は「最新の*song_diff*のid」を保持しておき、*song_diff*をinsertする際にはトランザクションを張って*song_item*の*latest_diff*を必ず更新する、という運用を行うことにしました。

<div class="d-flex flex-wrap">
  <div>
    <strong>変更前</strong>
    <img src="https://i.gyazo.com/f78a5ea74818140e52a7077dba175126.png" class="custom d-block mt-0" alt="変更前のER図" width="300">
  </div>
  <div>
    <strong>変更後</strong>
    <img src="https://i.gyazo.com/4df018469eb67c2344fb2700b9ba041d.png" class="custom d-block mt-0" alt="変更後のER図" width="300">
  </div>
</div>

この運用方法には次のようなメリット・デメリットがあります。  
- メリット  
  - 曲のタイトルや歌手名を参照する際に、単純なテーブルのjoinで取得が可能
  - *latest_diff_id*を用いてテーブルをjoinすれば歌の一覧を取得する際にN+1問題が発生しない
- デメリット
  - *song_diff*をinsertする際に毎回*song_item*を更新する必要があり、運用上バグが発生しやすい

今回は、N+1問題に起因するレスポンスの遅れが体感できるレベルだったため、デメリットを許容してこのような実装方式を採用しました。  
履歴情報を保持するという仕組みを作るのは初めてだったため、いい勉強になりました。
